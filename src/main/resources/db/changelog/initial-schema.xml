<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="create-traits-table" author="negrioska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="traits"/>
            </not>
        </preConditions>
        <createTable tableName="traits">
            <column name="idTraits" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="alcoholicBeverage" type="BOOL"/>
            <column name="cocktails" type="BOOL"/>
            <column name="beer" type="BOOL"/>
            <column name="coffee" type="BOOL"/>
            <column name="wine" type="BOOL"/>
            <column name="servesBreakfast" type="BOOL"/>
            <column name="servesLunch" type="BOOL"/>
            <column name="servesDinner" type="BOOL"/>
            <column name="servesDessert" type="BOOL"/>
            <column name="petFriendly" type="BOOL"/>
            <column name="liveMusic" type="BOOL"/>
            <column name="outdoorSeating" type="BOOL"/>
            <column name="vegetarianFood" type="BOOL"/>
            <column name="paidParking" type="BOOL"/>
        </createTable>
    </changeSet>

    <changeSet id="create-localProfile-table" author="negrioska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="localProfile"/>
            </not>
        </preConditions>
        <createTable tableName="localProfile">
            <column name="idLocal" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(255) NOT NULL"/>
            <column name="description" type="TEXT NOT NULL"/>
            <column name="mapsUri" type="VARCHAR(255) NOT NULL"/>
            <column name="phoneNumber" type="VARCHAR(255)"/>
            <column name="address" type="VARCHAR(255) NOT NULL"/>
            <column name="rating" type="DECIMAL(3, 1) NOT NULL"/>
            <column name="menuLink" type="VARCHAR(255)"/>
            <column name="dressCode" type="VARCHAR(100)"/>
            <column name="atmosphere" type="VARCHAR(100) NOT NULL"/>
            <column name="musicType" type="VARCHAR(100)"/>
            <column name="idTraits" type="UUID NOT NULL"/>
        </createTable>
        
        <addForeignKeyConstraint baseTableName="localProfile" 
                                 baseColumnNames="idTraits" 
                                 constraintName="fk_local_traits" 
                                 referencedTableName="traits"
                                 referencedColumnNames="idTraits"
                                 onDelete="RESTRICT"
                                 onUpdate="RESTRICT"/>
    </changeSet>

  <changeSet id="create-daily-offers" author="negrioska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="dailyOffers"/>
            </not>
        </preConditions>
        <createTable tableName="dailyOffers">
            <column name="idDailyOffer" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(100)"/>
            <column name="dateCreated" type="DATETIME NOT NULL"/>
            <column name="fromDate" type="DATETIME NOT NULL"/>
            <column name="toDate" type="DATETIME NOT NULL"/>
            <column name="description" type="VARCHAR(500) NOT NULL"/>
            <column name="image" type="VARBINARY(8000)"/>
            <column name="idLocal" type="UUID NOT NULL"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="dailyOffers"
                                 baseColumnNames="idLocal"
                                 constraintName="fk_local_daily_offers"
                                 referencedTableName="localProfile"
                                 referencedColumnNames="idLocal"
                                 onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="create-user-table" author="negrioska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="user"/>
            </not>
        </preConditions>
        <createTable tableName="user">
            <column name="idUser" type="UUID">
                <constraints primaryKey="true"/>
            </column>
            <column name="username" type="VARCHAR(100) NOT NULL"/>
            <column name="name" type="VARCHAR(100) NOT NULL"/>
            <column name="email" type="VARCHAR(100) NOT NULL"/>
            <column name="role" type="VARCHAR(100) NOT NULL"/>
        </createTable>
    </changeSet>

    <changeSet id="create-review-table" author="negrioska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="review"/>
            </not>
        </preConditions>
        <createTable tableName="review">
            <column name="idReview" type="UUID">
                <constraints primaryKey="true"/>
            </column>
            <column name="dateCreated" type="DATETIME NOT NULL"/>
            <column name="dateModified" type="DATETIME"/>
            <column name="rating" type="INT NOT NULL"/>
            <column name="description" type="VARCHAR(255) NOT NULL"/>
            <column name="idUser" type="UUID NOT NULL"/>
            <column name="idLocal" type="UUID NOT NULL"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="review"
                                 baseColumnNames="idUser"
                                 constraintName="fk_review_user"
                                 referencedTableName="user"
                                 referencedColumnNames="idUser"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"/>

        <addForeignKeyConstraint baseTableName="review"
                                 baseColumnNames="idLocal"
                                 constraintName="fk_review_local"
                                 referencedTableName="localProfile"
                                 referencedColumnNames="idLocal"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"/>
    </changeSet>
    <changeSet id="create-localAdmin-table" author="negrioska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="localAdmin"/>
            </not>
        </preConditions>
        <createTable tableName="localAdmin">
            <column name="idLocalAdmin" type="UUID">
                <constraints primaryKey="true"/>
            </column>
            <column name="idUser" type="UUID NOT NULL"/>
            <column name="idLocal" type="UUID NOT NULL"/>
            <column name="dateCreated" type="TIMESTAMP NOT NULL"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="localAdmin"
                                 baseColumnNames="idUser"
                                 constraintName="fk_localAdmin_user"
                                 referencedTableName="user"
                                 referencedColumnNames="idUser"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"/>

        <addForeignKeyConstraint baseTableName="localAdmin"
                                 baseColumnNames="idLocal"
                                 constraintName="fk_localAdmin_localProfile"
                                 referencedTableName="localProfile"
                                 referencedColumnNames="idLocal"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"/>
    </changeSet>

</databaseChangeLog>