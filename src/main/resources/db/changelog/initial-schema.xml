<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="create-trait-table" author="negrioska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="trait"/>
            </not>
        </preConditions>
        <createTable tableName="trait">
            <column name="trait_id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="alcoholic_beverage" type="BOOL NOT NULL"/>
            <column name="cocktails" type="BOOL NOT NULL"/>
            <column name="beer" type="BOOL NOT NULL"/>
            <column name="wine" type="BOOL NOT NULL"/>
            <column name="coffee" type="BOOL NOT NULL"/>
            <column name="serves_breakfast" type="BOOL NOT NULL"/>
            <column name="serves_lunch" type="BOOL NOT NULL"/>
            <column name="serves_dinner" type="BOOL NOT NULL"/>
            <column name="serves_dessert" type="BOOL NOT NULL"/>
            <column name="vegetarian_food" type="BOOL NOT NULL"/>
            <column name="pet_friendly" type="BOOL NOT NULL"/>
            <column name="outdoor_seating" type="BOOL NOT NULL"/>
            <column name="paid_parking" type="BOOL NOT NULL"/>
            <column name="live_music" type="BOOL NOT NULL"/>
            <column name="dress_code" type="VARCHAR(100) NOT NULL"/>
            <column name="atmosphere" type="VARCHAR(100) NOT NULL"/>
            <column name="music_type" type="VARCHAR(100) NOT NULL"/>
        </createTable>
    </changeSet>

    <changeSet id="create-local-profile-table" author="negrioska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="local_profile"/>
            </not>
        </preConditions>
        <createTable tableName="local_profile">
            <column name="local_id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(255) NOT NULL"/>
            <column name="description" type="TEXT NOT NULL"/>
            <column name="maps_uri" type="VARCHAR(255) NOT NULL"/>
            <column name="phone_number" type="VARCHAR(255)"/>
            <column name="address" type="VARCHAR(255) NOT NULL"/>
            <column name="rating" type="DECIMAL(3, 1) NOT NULL"/>
            <column name="menu_link" type="VARCHAR(255)"/>
            <column name="trait_id" type="UUID NOT NULL"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="local_profile"
                                 baseColumnNames="trait_id"
                                 constraintName="fk_local_trait"
                                 referencedTableName="trait"
                                 referencedColumnNames="trait_id"
                                 onDelete="RESTRICT"
                                 onUpdate="RESTRICT"/>
    </changeSet>

    <changeSet id="create-daily-offer" author="negrioska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="daily_offer"/>
            </not>
        </preConditions>
        <createTable tableName="daily_offer">
            <column name="daily_offer_id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(100)"/>
            <column name="date_created" type="DATETIME NOT NULL"/>
            <column name="from_date" type="DATETIME NOT NULL"/>
            <column name="to_date" type="DATETIME NOT NULL"/>
            <column name="description" type="VARCHAR(500) NOT NULL"/>
            <column name="image" type="VARBINARY(8000)"/>
            <column name="local_id" type="UUID NOT NULL"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="daily_offer"
                                 baseColumnNames="local_id"
                                 constraintName="fk_local_daily_offer"
                                 referencedTableName="local_profile"
                                 referencedColumnNames="local_id"
                                 onUpdate="CASCADE"
                                 onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="create-user-table" author="negrioska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="user"/>
            </not>
        </preConditions>
        <createTable tableName="user">
            <column name="user_id" type="UUID">
                <constraints primaryKey="true"/>
            </column>
            <column name="username" type="VARCHAR(100) NOT NULL"/>
            <column name="name" type="VARCHAR(100) NOT NULL"/>
            <column name="email" type="VARCHAR(100) NOT NULL"/>
            <column name="role" type="VARCHAR(100) NOT NULL"/>
        </createTable>
    </changeSet>

    <changeSet id="create-review-table" author="negrioska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="review"/>
            </not>
        </preConditions>
        <createTable tableName="review">
            <column name="review_id" type="UUID">
                <constraints primaryKey="true"/>
            </column>
            <column name="date_created" type="DATETIME NOT NULL"/>
            <column name="date_modified" type="DATETIME"/>
            <column name="rating" type="INT NOT NULL"/>
            <column name="description" type="VARCHAR(255) NOT NULL"/>
            <column name="user_id" type="UUID NOT NULL"/>
            <column name="local_id" type="UUID NOT NULL"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="review"
                                 baseColumnNames="review_id"
                                 constraintName="fk_review_user"
                                 referencedTableName="user"
                                 referencedColumnNames="user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"/>

        <addForeignKeyConstraint baseTableName="review"
                                 baseColumnNames="local_id"
                                 constraintName="fk_review_local"
                                 referencedTableName="local_profile"
                                 referencedColumnNames="local_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"/>
    </changeSet>
    <changeSet id="create-local-admin-table" author="negrioska">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="local_admin"/>
            </not>
        </preConditions>
        <createTable tableName="local_admin">
            <column name="admin_id" type="UUID">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="UUID NOT NULL"/>
            <column name="local_id" type="UUID NOT NULL"/>
            <column name="date_created" type="TIMESTAMP NOT NULL"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="local_admin"
                                 baseColumnNames="user_id"
                                 constraintName="fk_local_admin_user"
                                 referencedTableName="user"
                                 referencedColumnNames="user_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"/>

        <addForeignKeyConstraint baseTableName="local_profile"
                                 baseColumnNames="local_id"
                                 constraintName="fk_local_admin_local_profile"
                                 referencedTableName="local_profile"
                                 referencedColumnNames="local_id"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"/>
    </changeSet>
</databaseChangeLog>